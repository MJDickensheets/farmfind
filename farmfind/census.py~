from enum import Enum
from functools import partial
from http.client import HTTPSConnection
from json import loads
from typing import Any

API_KEY = 'de13c14fa8937c82618fa846f90fd7cc8df4b02d'
URL_ROOT = "api.census.gov"
MEDIAN_INCOME = "B19326_001E"


class Dataset(Enum):
    ACS = "acs/acs1"
    CHARAGEGROUPS = "pep/charagegroups"

    def __str__(self):
        return str(self.value)


def mk_query(year: int, dataset: Dataset, **kwargs: Any) -> str:
    """Assemble a query for API consumption.

    >>> mk_query(year=2019,dataset=Dataset.CHARAGEGROUPS,get="NAME,POP",HISP=2,_for="state:*")
    '/data/2019/pep/charagegroups?get=NAME,POP&HISP=2&for=state:*'
    """

    return (
        f"/data/{year}/{dataset}"
        f"?{'&'.join(f'{k.strip("_")}={str(v)}' for k, v in kwargs.items())}"
        f"&key={API_KEY}"
    )



def get(query: str) -> Any | None:
    conn = HTTPSConnection(URL_ROOT)
    conn.request("GET", query)
    resp = conn.getresponse()
    match resp.status:
        case 200:
            return loads(resp.read())
    return None


if __name__ == "__main__":
    median_income_state = mk_query(2024, Dataset.ACS, get=MEDIAN_INCOME, _for="state:*")
    median_income_county = mk_query(2024, Dataset.ACS, get=MEDIAN_INCOME, _for="county:*")
    from pprint import pprint
    pprint(get(median_income_county)[:10])


